function draw(t,e,a,o,r,n){function l(t){for(var e=0;e<t.length;e++)t[e].load_volume=+t[e].load_volume;return t}function i(){var o="water_collected",r="Days",n=d(r,o);n.success(function(n){n=l(n),n=convertToMilliseconds(n);var i=setXDomain(r,t,a),d=setYDomain(n,e,a);d3.select("#date-period").html(""+strftime("%b %e %Y",new Date(i.domain()[0]))+" - "+strftime("%b %e %Y",new Date(i.domain()[1])));var s=d3.svg.axis().scale(i).orient("bottom").ticks(d3.time.days,1).tickFormat(d3.time.format("%d")).tickSize(0).tickPadding(8),m=d3.select("body").append("div").attr("class","graph-tooltip"),v=d3.select("#graphContainer").insert("svg","#usage_stats").attr("class","chart").attr("width",t).attr("height",e).append("g").attr("transform","translate("+a.left+","+a.top+")").attr("id","graph");c(n,v,i,d,m,s,r,o),toolTipMouseOver(m),$("ul#time_scale li").on("click",function(){$(this).hasClass("time-period")&&($("#time_scale li").removeClass("current"),$(this).addClass("current")),r=$("ul#time_scale li.current").text(),u(v,i,d,s,m,r,o)}),$("#metric_select").on("change",function(){if($(this).is("#metric_select")){var t=$("#metric_select option:selected").attr("value").split(" ");t=t[0].toLowerCase()+"_"+t[1].toLowerCase(),$(".meta_stats").hide(),$("#meta_stats_"+t).show(),$(".explanation").hide()}o=$("#metric_select option:selected").attr("value").split(" "),o=o[0]+" "+o[1],u(v,i,d,s,m,r,o)})})}function u(t,e,a,o,r,n,i){var u="Update",s=d(n,i);s.success(function(d){if(d=l(d),d=convertToMilliseconds(d),"Weeks"==n||"Months"==n)for(var s=0;s<d.length;s++)d[s].load_volume=d[s].total_load_volume;updateXDomain(d,e,n),updateYDomain(d,a,n),updateTickFormat(o,e,n),d3.select("#date-period").html(""+strftime("%b %e %Y",new Date(e.domain()[0]))+" - "+strftime("%b %e %Y",new Date(e.domain()[1]))),c(d,t,e,a,r,o,n,i,u),toolTipMouseOver(r)})}function c(t,n,l,i,u,c,d,v,f){var _=n.selectAll("rect").data(t,function(t){return t.date}),p=n.selectAll("text").data(t,function(t){return t.date}),h=n.selectAll("circle").data(t,function(t){return t.date}),x="rgba(150,150,150,0.2)",g="rgba(65,131,175,.9)",y="rgba(220,131,65,0.6)",b="rgba(196,131,65,0.0)";"Update"==f&&(_.transition().duration(m).delay(s).attr("x",function(t){return l(t.date)}).attr("y",function(t){return 0==t.load_volume?i(t.load_volume)-30:i(t.load_volume)}).attr("height",function(t){return 0==t.load_volume?30:e-a.top-a.bottom-i(t.load_volume)}).style("fill",function(t){return 0==t.load_volume?x:g}),p.transition().duration(m).delay(s).attr("x",function(t){return l(new Date(t.date))+o/2}).attr("y",function(t){return i(t.load_volume)+20}).text(function(t){return 0==t.load_volume?null:format(t.load_volume,v)}),h.transition().duration(m).delay(s).attr("cx",function(t){return l(new Date(t.date))+o/2}).attr("cy",function(t){return i(t.load_volume)+20})),_.enter().append("rect").attr("x",function(t){return l(t.date)}).attr("y",function(t){return 0==t.load_volume?i(t.load_volume)-30:i(t.load_volume)}).attr("rx",5).attr("ry",5).attr("height",function(t){return 0==t.load_volume?30:e-a.top-a.bottom-i(t.load_volume)}).attr("width",o).attr("class","bar").style("fill",function(t){return 0==t.load_volume?x:g}).on("mouseover",function(t,e){return barMouseOver(t,e,l,i,_,u,r,$("ul#time_scale li.current").text(),$("#metric_select option:selected").attr("value"),o)}).on("mouseout",function(t,e){return barMouseOut(t,e,_,u)}),p.enter().append("text").attr("x",function(t){return l(new Date(t.date))+o/2}).attr("y",function(e){return i(e.load_volume)>.125*d3.max(t,function(t){return t.load_volume})?i(e.load_volume)+20:i(e.load_volume)+20}).attr("text-anchor","middle").text(function(t){return 0==t.load_volume?null:format(t.load_volume)}),console.log("METRIC: "+v),"Days"!=d||"water_collected"!=v&&"Water Collected"!=v?h.style("opacity","0"):h.enter().append("circle").attr("cx",function(t){return l(t.date)}).attr("cy",function(t){return 0==t.load_volume?i(t.load_volume)-30:i(t.load_volume)}).attr("r",8).attr("class","circle").style("fill",function(t){return 0==t.load_volume?b:y}),n.append("g").attr("class","x axis").attr("transform","translate("+padding+","+(e-a.bottom-a.top)+")").call(c).selectAll("text").attr("dx",function(){return"Days"==d?"0.5em":"Weeks"==d?"1.5em":"1.05em"}),"Update"==f&&(_.exit().remove(),p.exit().remove(),h.exit().remove())}function d(t,e){return $.ajax({url:"/rain_barrel/get_history.json",data:{metric:e,time:t},dataType:"json"})}var s=function(t,e){return 5*e},m=750;e=e-a.top-a.bottom,padding=0,i(n)}